<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Muscle & Macro Architect</title>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#1a1a1a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <!-- PWA Manifest (URL Encoded for stability) -->
    <link rel="manifest"
        href='data:application/json;charset=utf-8,%7B%22name%22%3A%22Muscle%20%26%20Macro%20Architect%22%2C%22short_name%22%3A%22MMA%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%231a1a1a%22%2C%22theme_color%22%3A%22%231a1a1a%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F2554%2F2554039.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>
    <!-- CDNs -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        primary: '#B6F262', // Neon Lime
                        surface: '#242424',
                        background: '#121212',
                        accent: '#E0E0E0',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #121212;
            color: #E0E0E0;
            -webkit-tap-highlight-color: transparent;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #121212;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 2px;
        }

        .water-wave {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            transition: height 0.5s ease-in-out;
            background: linear-gradient(180deg, #4FC3F7 0%, #0288D1 100%);
            opacity: 0.6;
            z-index: 0;
        }

        .app-container {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            padding-bottom: 80px;
        }
    </style>
</head>

<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        // --- Data & Constants ---
        const DAYS = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes'];
        const VERSION_KEY = 'gym_data_v5';
        const DEFAULT_DIET = [
            { id: 'breakfast', name: 'Desayuno', items: 'Creatina + 2 Huevos plancha + 1 Tostada', calories: 435, macros: { p: 30, c: 45, f: 15 }, consumed: false },
            { id: 'lunch', name: 'Comida', items: '50g Arroz + 200g Pollo/Ternera + Ensalada (50g Maíz, 80g Atún)', calories: 735, macros: { p: 70, c: 80, f: 15 }, consumed: false },
            { id: 'snack', name: 'Merienda', items: '2 Yogures + 1 cazo Proteína', calories: 410, macros: { p: 50, c: 30, f: 10 }, consumed: false },
            { id: 'dinner', name: 'Cena', items: '2 Huevos + 80g Atún', calories: 415, macros: { p: 60, c: 10, f: 15 }, consumed: false },
        ];
        const WORKOUT_ROUTINE = {
            'Lunes': {
                focus: 'Pecho A / Tríceps / Hombro',
                exercises: [
                    { id: 'l1', name: 'Press Banca Plano', sets: '4x8-10' },
                    { id: 'l2', name: 'Press Inclinado Mancuernas', sets: '3x10-12' },
                    { id: 'l3', name: 'Aperturas', sets: '3x12-15' },
                    { id: 'l4', name: 'Press Militar', sets: '4x8-10' },
                    { id: 'l5', name: 'Elevaciones Laterales', sets: '4x12-15' },
                    { id: 'l6', name: 'Extensiones Tríceps Polea', sets: '4x12-15' }
                ]
            },
            'Martes': {
                focus: 'Espalda / Bíceps',
                exercises: [
                    { id: 'm1', name: 'Jalón al Pecho', sets: '4x10-12' },
                    { id: 'm2', name: 'Remo Gironda', sets: '4x10-12' },
                    { id: 'm3', name: 'Pull Over Polea', sets: '3x12-15' },
                    { id: 'm4', name: 'Curl Barra Z', sets: '4x10-12' },
                    { id: 'm5', name: 'Curl Martillo', sets: '3x10-12' },
                    { id: 'm6', name: 'Face Pull', sets: '3x15' }
                ]
            },
            'Miércoles': {
                focus: 'Pierna Completa',
                exercises: [
                    { id: 'x1', name: 'Sentadilla Libre/Multipower', sets: '4x6-8' },
                    { id: 'x2', name: 'Prensa 45º', sets: '4x10-12' },
                    { id: 'x3', name: 'Peso Muerto Rumano', sets: '4x8-10' },
                    { id: 'x4', name: 'Extensiones Cuádriceps', sets: '3x15' },
                    { id: 'x5', name: 'Curl Femoral Tumbado', sets: '3x12-15' },
                    { id: 'x6', name: 'Gemelo en Prensa', sets: '4x15-20' }
                ]
            },
            'Jueves': {
                focus: 'Pecho B / Hombro / Fuerza',
                exercises: [
                    { id: 'j1', name: 'Peso Muerto Convencional', sets: '3x6 (Fuerza)' },
                    { id: 'j2', name: 'Press Inclinado Mancuernas', sets: '4x8-10' },
                    { id: 'j3', name: 'Fondos en Paralelas', sets: '3xFall' },
                    { id: 'j4', name: 'Press Arnold', sets: '3x10-12' },
                    { id: 'j5', name: 'Pájaros (Hombro Posterior)', sets: '3x15' },
                    { id: 'j6', name: 'Press Francés', sets: '3x10-12' }
                ]
            },
            'Viernes': {
                focus: 'Full Body / Brazos',
                exercises: [
                    { id: 'v1', name: 'Dominadas', sets: '4xFall' },
                    { id: 'v2', name: 'Zancadas', sets: '3x12/pierna' },
                    { id: 'v3', name: 'Curl Bíceps Scott', sets: '3x12' },
                    { id: 'v4', name: 'Tríceps Copa', sets: '3x12' },
                    { id: 'v5', name: 'Elevaciones Frontales', sets: '3x12' },
                    { id: 'v6', name: 'Abdominales (Rueda/Plancha)', sets: '4 Sets' }
                ]
            }
        };
        // --- Utility ---
        const getTodayString = () => new Date().toISOString().split('T')[0];
        // --- Components ---
        const Icon = ({ name, className }) => <span className={`material-icons-round ${className}`}>{name}</span>;
        const TabBar = ({ activeTab, setTab }) => (
            <div className="fixed bottom-0 left-0 w-full bg-surface/95 backdrop-blur-md border-t border-white/10 flex justify-around p-3 z-50 rounded-t-2xl shadow-2xl">
                {['dashboard', 'diet', 'routine'].map(tab => (
                    <button
                        key={tab}
                        onClick={() => setTab(tab)}
                        className={`flex flex-col items-center gap-1 transition-all duration-300 ${activeTab === tab ? 'text-primary scale-110' : 'text-gray-500'}`}
                    >
                        <Icon name={tab === 'dashboard' ? 'grid_view' : tab === 'diet' ? 'restaurant' : 'fitness_center'} className="text-2xl" />
                        <span className="text-[10px] font-bold uppercase tracking-wider">{tab === 'routine' ? 'Rutina' : tab === 'diet' ? 'Dieta' : 'Inicio'}</span>
                    </button>
                ))}
            </div>
        );
        const Dashboard = ({ data, updateWater }) => {
            const waterPercent = Math.min((data.water / 4) * 100, 100);
            // Calculate consumed totals
            const totals = data.diet.reduce((acc, meal) => {
                if (meal.consumed) {
                    acc.calories += meal.calories;
                    acc.p += (meal.macros ? meal.macros.p : 0);
                    acc.c += (meal.macros ? meal.macros.c : 0);
                    acc.f += (meal.macros ? meal.macros.f : 0);
                }
                return acc;
            }, { calories: 0, p: 0, c: 0, f: 0 });
            const TARGETS = { calories: 2000, p: 210, c: 165, f: 55 };
            // Cardio Logic (Cycle: 2 days ON, 1 day OFF)
            const today = new Date();
            const dayIndex = Math.floor(today.getTime() / (1000 * 60 * 60 * 24));
            const cardioStatus = (dayIndex % 3) !== 2 ? "Hoy Toca" : "Descanso";
            const ProgressBar = ({ label, current, target, colorClass }) => {
                const pct = Math.min((current / target) * 100, 100);
                return (
                    <div className="mb-2 last:mb-0">
                        <div className="flex justify-between text-xs mb-1">
                            <span className="text-gray-400 font-bold">{label}</span>
                            <span className="text-white">{Math.round(current)} / {target}g</span>
                        </div>
                        <div className="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                            <div className={`h-full ${colorClass}`} style={{ width: `${pct}%`, transition: 'width 0.5s ease-out' }}></div>
                        </div>
                    </div>
                );
            };
            return (
                <div className="space-y-6 animate-fade-in pb-20">
                    <header className="flex justify-between items-center mb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-white">Hola, Atleta</h1>
                            <p className="text-sm text-gray-400">Objetivo: Ganancia Muscular</p>
                        </div>
                        <button onClick={() => window.dispatchEvent(new CustomEvent('open-settings'))} className="w-10 h-10 rounded-full bg-surface border border-white/10 flex items-center justify-center text-gray-400 hover:text-white transition-colors">
                            <Icon name="settings" className="text-xl" />
                        </button>
                    </header>
                    {/* Macros Card */}
                    <div className="bg-surface p-5 rounded-2xl shadow-lg border border-white/5 relative overflow-hidden">
                        <div className="flex justify-between items-end mb-4 relative z-10">
                            <span className="text-gray-400 font-medium">Calorías Hoy</span>
                            <span className="text-3xl font-bold text-white">{totals.calories} <span className="text-sm text-gray-400">/ 2000</span></span>
                        </div>
                        <div className="w-full h-3 bg-black/40 rounded-full overflow-hidden mb-5">
                            <div
                                className="h-full bg-gradient-to-r from-primary to-green-400"
                                style={{ width: `${Math.min((totals.calories / 2000) * 100, 100)}%`, transition: 'width 0.5s ease-out' }}
                            ></div>
                        </div>
                        <div className="space-y-2 relative z-10">
                            <ProgressBar label="PROTEÍNA" current={totals.p} target={TARGETS.p} colorClass="bg-blue-500" />
                            <ProgressBar label="CARBOHIDRATOS" current={totals.c} target={TARGETS.c} colorClass="bg-orange-500" />
                            <ProgressBar label="GRASAS" current={totals.f} target={TARGETS.f} colorClass="bg-yellow-500" />
                        </div>
                    </div>
                    {/* Water Tracker */}
                    <div className="bg-surface p-0 rounded-2xl shadow-lg border border-white/5 relative overflow-hidden h-40 flex items-center justify-center">
                        <div className="water-wave" style={{ height: `${waterPercent}%` }}></div>
                        <div className="z-10 text-center">
                            <h3 className="text-white font-medium mb-1 drop-shadow-md">Hidratación</h3>
                            <div className="text-4xl font-black text-white drop-shadow-md">{data.water}<span className="text-lg">L</span> / 4L</div>
                            <button
                                onClick={() => updateWater(0.25)}
                                className="mt-2 bg-white/20 hover:bg-white/30 backdrop-blur text-white px-4 py-1 rounded-full text-sm font-bold transition-colors"
                            >
                                + 250ml
                            </button>
                        </div>
                    </div>
                    {/* Cardio Status */}
                    <div className={`p-5 rounded-2xl shadow-lg border border-white/5 flex items-center justify-between ${cardioStatus === 'Descanso' ? 'bg-gray-800' : 'bg-gradient-to-br from-orange-500/20 to-red-500/20'}`}>
                        <div>
                            <p className="text-gray-400 text-xs uppercase tracking-widest font-bold">Cardio Cíclico</p>
                            <h2 className={`text-2xl font-black mt-1 ${cardioStatus === 'Descanso' ? 'text-gray-300' : 'text-orange-400'}`}>
                                {cardioStatus.toUpperCase()}
                            </h2>
                        </div>
                        <Icon name={cardioStatus === 'Descanso' ? 'bedtime' : 'directions_run'} className={`text-4xl ${cardioStatus === 'Descanso' ? 'text-gray-500' : 'text-orange-400'}`} />
                    </div>
                </div>
            );
        };
        const Diet = ({ diet, updateDiet, toggleMeal, mockScan }) => {
            return (
                <div className="space-y-4 pb-20">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">Plan Nutricional</h2>
                        <h2 className="text-xl font-bold">Plan Nutricional</h2>
                        <button onClick={mockScan} className="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-cyan-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow-lg shadow-blue-900/20 active:scale-95 transition-transform">
                            <Icon name="center_focus_weak" className="text-sm" /> Vision AI
                        </button>
                    </div>
                    {diet.map((meal, index) => (
                        <div key={meal.id} className={`p-4 rounded-xl border transition-all duration-300 ${meal.consumed ? 'bg-primary/5 border-primary/30' : 'bg-surface border-white/5'}`}>
                            <div className="flex justify-between items-start mb-2">
                                <div>
                                    <h3 className={`font-bold ${meal.consumed ? 'text-primary' : 'text-white'}`}>{meal.name}</h3>
                                    <div className="flex gap-2 mt-1 text-[10px] uppercase font-bold text-gray-500 tracking-wider">
                                        <span className="text-blue-400">P: {meal.macros?.p}</span>
                                        <span className="text-orange-400">C: {meal.macros?.c}</span>
                                        <span className="text-yellow-400">G: {meal.macros?.f}</span>
                                    </div>
                                </div>
                                <div className="flex flex-col items-end gap-2">
                                    <span className="text-xs text-gray-400 font-mono bg-black/20 px-2 py-0.5 rounded">{meal.calories} kcal</span>
                                    <button
                                        onClick={() => toggleMeal(index)}
                                        className={`w-6 h-6 rounded-full border-2 flex items-center justify-center transition-colors ${meal.consumed ? 'bg-primary border-primary' : 'border-gray-600 hover:border-gray-400'}`}
                                    >
                                        {meal.consumed && <Icon name="check" className="text-black text-sm font-bold" />}
                                    </button>
                                </div>
                            </div>
                            <textarea
                                className={`w-full bg-black/20 text-sm p-3 rounded-lg border focus:border-primary/50 focus:outline-none resize-none transition-colors ${meal.consumed ? 'text-gray-500 border-transparent' : 'text-gray-300 border-white/5'}`}
                                rows="2"
                                value={meal.items}
                                onChange={(e) => updateDiet(index, e.target.value)}
                            />
                        </div>
                    ))}
                </div>
            );
        };
        const Routine = ({ history, exercises, updateExercise }) => {
            const [selectedDay, setSelectedDay] = useState('Lunes');
            const checkForceAlert = (day) => {
                const dayHistory = history[day] || [];
                // Needs at least 2 sessions to possibly have a "streak" of 2 weeks
                if (dayHistory.length < 2) return false;
                let streak = 0;
                for (let i = dayHistory.length - 1; i >= 0; i--) {
                    const session = dayHistory[i];
                    if (session.maintained) {
                        break;
                    }
                    streak++;
                }
                // If streak >= 2 (2 clean sessions), SHOW ALERT
                return streak >= 2;
            };
            const dayRoutine = WORKOUT_ROUTINE[selectedDay];
            const forceAlert = checkForceAlert(selectedDay);
            return (
                <div className="h-full flex flex-col pb-20">
                    <div className="flex overflow-x-auto gap-2 mb-6 pb-2 no-scrollbar">
                        {DAYS.map(day => (
                            <button
                                key={day}
                                onClick={() => setSelectedDay(day)}
                                className={`px-4 py-2 rounded-full whitespace-nowrap text-sm font-bold transition-all ${selectedDay === day ? 'bg-primary text-black shadow-lg shadow-primary/20' : 'bg-surface text-gray-400'}`}
                            >
                                {day}
                            </button>
                        ))}
                    </div>
                    {dayRoutine ? (
                        <div className="flex-1 space-y-4">
                            <div className="flex justify-between items-center">
                                <h2 className="text-lg font-bold text-white uppercase tracking-wider">{dayRoutine.focus}</h2>
                                {forceAlert && (
                                    <div className="animate-pulse bg-red-500/20 text-red-400 px-3 py-1 rounded-full text-xs font-black border border-red-500/50">
                                        ¡Sube +2.5kg!
                                    </div>
                                )}
                            </div>
                            {dayRoutine.exercises.map((ex, idx) => (
                                <ExerciseRow
                                    key={ex.id}
                                    exercise={ex}
                                    status={exercises[ex.id] || {}}
                                    update={(kg, done, maintain) => updateExercise(ex.id, selectedDay, kg, done, maintain)}
                                />
                            ))}
                        </div>
                    ) : (
                        <div className="flex items-center justify-center h-40 text-gray-500">
                            Descanso / No asignado
                        </div>
                    )}
                </div>
            );
        };
        const ExerciseRow = ({ exercise, status, update }) => {
            // Validate if "Done" is valid for TODAY
            const today = getTodayString();
            const isDoneToday = status.lastDone === today;
            // Local state for input before confirming? No, sync directly for simple UX
            // Or maybe sync on blur. Let's sync on change for now but persist in App.
            const [localKg, setLocalKg] = useState(status.kg || '');
            // Sync local state if prop changes (e.g. on load)
            useEffect(() => {
                if (status.kg !== undefined) setLocalKg(status.kg);
            }, [status.kg]);
            const toggle = () => {
                // If currently done, uncheck (false, status.maintained). 
                // If not done, check (true, status.maintained || false)
                update(localKg, !isDoneToday, status.maintained || false); // Keep current maintain status if unchecking... wait.
                // Reset maintained if unchecking? User said "exercises se dejen de marca". 
                // Ideally maintain is bound to the completion.
            };
            const handleKgChange = (e) => {
                const val = e.target.value;
                setLocalKg(val);
                // Update parent immediately so state is saved
                update(val, isDoneToday, status.maintained || false);
            };
            const toggleMaintain = () => {
                // Only allowed if NOT done... or allowed anytime?
                // User said: "cuando marco cualquier ejercicio marca lo de sube".
                // "Maintain" implies "I did it but kept weight". 
                // So usually toggle maintain BEFORE or AFTER checking?
                // Let's allow anytime, but only effective if done.
                // update(kg, done, !maintained)
                if (!isDoneToday) {
                    update(localKg, isDoneToday, !(status.maintained || false));
                }
            };
            return (
                <div className={`flex flex-col gap-2 p-3 rounded-xl border transition-all duration-300 ${isDoneToday ? 'bg-primary/10 border-primary/30' : 'bg-surface border-white/5'}`}>
                    <div className="flex items-center gap-3">
                        <div
                            onClick={toggle}
                            className={`w-6 h-6 rounded-full border-2 flex items-center justify-center cursor-pointer transition-colors ${isDoneToday ? 'bg-primary border-primary' : 'border-gray-500 hover:border-gray-300'}`}
                        >
                            {isDoneToday && <Icon name="check" className="text-black text-sm font-bold" />}
                        </div>
                        <div className="flex-1">
                            <h4 className={`font-semibold text-sm ${isDoneToday ? 'text-primary' : 'text-gray-200'}`}>{exercise.name}</h4>
                            <p className="text-xs text-gray-500">{exercise.sets}</p>
                        </div>
                        <div className="flex gap-2 items-center">
                            <input
                                placeholder="kg"
                                className="w-16 bg-black/30 border border-white/10 rounded text-center text-sm py-1 focus:border-primary/50 outline-none text-white font-bold"
                                value={localKg}
                                onChange={handleKgChange}
                            />
                            {/* Reps removed per user request */}
                        </div>
                    </div>
                    {/* Maintain Toggle */}
                    <div className="flex items-center justify-end gap-2 pr-1">
                        <label className="text-[10px] text-gray-400 uppercase font-bold tracking-wider cursor-pointer select-none flex items-center gap-2">
                            Mantener peso
                            <div
                                onClick={toggleMaintain}
                                className={`w-8 h-4 rounded-full relative transition-colors ${status.maintained ? 'bg-orange-500' : 'bg-gray-700'} ${isDoneToday ? 'opacity-50 cursor-not-allowed' : ''}`}
                            >
                                <div className={`absolute top-0.5 w-3 h-3 rounded-full bg-white transition-all ${status.maintained ? 'left-4.5' : 'left-0.5'}`} style={{ left: status.maintained ? 'calc(100% - 14px)' : '2px' }}></div>
                            </div>
                        </label>
                    </div>
                </div>
            );
        };
        // --- Vision AI Components ---
        const SettingsModal = ({ apiKey, setApiKey, onClose }) => {
            const [input, setInput] = useState(apiKey || '');
            const save = () => {
                setApiKey(input);
                onClose();
            };
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-surface border border-white/10 p-6 rounded-2xl w-full max-w-sm shadow-2xl">
                        <h2 className="text-xl font-bold mb-4 flex items-center gap-2">
                            <Icon name="settings" className="text-primary" /> Configuración AI
                        </h2>
                        <p className="text-sm text-gray-400 mb-4">Introduce tu Google Gemini API Key para activar Vision AI.</p>
                        <input
                            type="password"
                            placeholder="Pegar API Key aquí..."
                            className="w-full bg-black/30 border border-white/10 rounded-lg p-3 text-white focus:border-primary/50 outline-none mb-4"
                            value={input}
                            onChange={e => setInput(e.target.value)}
                        />
                        <div className="flex gap-2">
                            <button onClick={onClose} className="flex-1 py-2 rounded-lg bg-gray-700 text-white font-bold">Cancelar</button>
                            <button onClick={save} className="flex-1 py-2 rounded-lg bg-primary text-black font-bold">Guardar</button>
                        </div>
                        <div className="mt-4 text-xs text-center text-gray-500">
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" className="underline hover:text-primary">Conseguir API Key gratis</a>
                        </div>
                    </div>
                </div>
            );
        };
        const CameraModal = ({ isOpen, onClose, onCapture }) => {
            const videoRef = React.useRef(null);
            const [stream, setStream] = useState(null);
            const [facingMode, setFacingMode] = useState('environment');
            useEffect(() => {
                if (isOpen) startCamera();
                return () => stopCamera();
            }, [isOpen, facingMode]);
            const startCamera = async () => {
                try {
                    if (stream) stopCamera();
                    const newStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: facingMode }
                    });
                    setStream(newStream);
                    if (videoRef.current) videoRef.current.srcObject = newStream;
                } catch (err) {
                    console.error("Camera Error:", err);
                    alert("No se pudo acceder a la cámara. Asegúrate de dar permisos.");
                    onClose();
                }
            };
            const stopCamera = () => {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    setStream(null);
                }
            };
            const capture = () => {
                if (!videoRef.current) return;
                const canvas = document.createElement('canvas');
                canvas.width = videoRef.current.videoWidth;
                canvas.height = videoRef.current.videoHeight;
                canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
                // Convert to base64 (jpeg)
                const imageBase64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                stopCamera();
                onCapture(imageBase64);
            };
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 bg-black flex flex-col">
                    <div className="relative flex-1 bg-black overflow-hidden flex items-center justify-center">
                        <video ref={videoRef} autoPlay playsInline className="absolute w-full h-full object-cover"></video>
                        {/* Overlay Grid */}
                        <div className="absolute inset-0 border-[30px] border-black/30 pointer-events-none">
                            <div className="w-full h-full border-2 border-primary/50 opacity-50 relative">
                                <div className="absolute top-0 left-0 w-4 h-4 border-t-2 border-l-2 border-primary"></div>
                                <div className="absolute top-0 right-0 w-4 h-4 border-t-2 border-r-2 border-primary"></div>
                                <div className="absolute bottom-0 left-0 w-4 h-4 border-b-2 border-l-2 border-primary"></div>
                                <div className="absolute bottom-0 right-0 w-4 h-4 border-b-2 border-r-2 border-primary"></div>
                            </div>
                        </div>
                    </div>
                    <div className="h-32 bg-black flex items-center justify-around px-10 pb-6 pt-2">
                        <button onClick={onClose} className="p-3 rounded-full bg-gray-800 text-white">
                            <Icon name="close" />
                        </button>
                        <button onClick={capture} className="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center bg-transparent active:scale-90 transition-transform">
                            <div className="w-14 h-14 rounded-full bg-white"></div>
                        </button>
                        <button onClick={() => setFacingMode(prev => prev === 'user' ? 'environment' : 'user')} className="p-3 rounded-full bg-gray-800 text-white">
                            <Icon name="flip_camera_ios" />
                        </button>
                    </div>
                </div>
            );
        };
        // --- Main App ---
        const App = () => {
            const [tab, setTab] = useState('dashboard');
            // State
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem(VERSION_KEY);
                return saved ? JSON.parse(saved) : {
                    water: 0,
                    diet: DEFAULT_DIET,
                    history: {},
                    exercises: {} // { id: { kg: '', lastDone: 'date', maintained: bool } }
                };
            });
            // Persistence
            useEffect(() => {
                localStorage.setItem(VERSION_KEY, JSON.stringify(data));
            }, [data]);
            // Actions
            const updateWater = (amount) => {
                setData(prev => ({ ...prev, water: Math.min(Math.round((prev.water + amount) * 100) / 100, 5) }));
            };
            const updateDiet = (index, newText) => {
                const newDiet = [...data.diet];
                newDiet[index].items = newText;
                setData(prev => ({ ...prev, diet: newDiet }));
            };
            const toggleMeal = (index) => {
                const newDiet = [...data.diet];
                newDiet[index].consumed = !newDiet[index].consumed;
                setData(prev => ({ ...prev, diet: newDiet }));
            };
            // --- Vision AI Logic ---
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [showCamera, setShowCamera] = useState(false);
            const [analyzing, setAnalyzing] = useState(false);
            useEffect(() => {
                localStorage.setItem('gemini_api_key', apiKey);
            }, [apiKey]);
            useEffect(() => {
                const openSettings = () => setShowSettings(true);
                window.addEventListener('open-settings', openSettings);
                return () => window.removeEventListener('open-settings', openSettings);
            }, []);
            const mockScan = () => {
                if (!apiKey) {
                    alert("⚠️ Configura tu API Key primero.");
                    setShowSettings(true);
                    return;
                }
                setShowCamera(true);
            };
            const handleImageCaptured = async (base64Image) => {
                setShowCamera(false);
                setAnalyzing(true);
                try {
                    // Call Gemini API
                    const PROMPT = "Analiza esta imagen de comida. Identifica el nombre del plato principal, estima las calorías aproximadas, y desglosa los macros (proteína, carbohidratos, grasas). Devuelve SOLO un objeto JSON válido con este formato, sin markdown ni texto adicional: { \"name\": \"Nombre del plato\", \"calories\": 0, \"macros\": { \"p\": 0, \"c\": 0, \"f\": 0 } }";
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: PROMPT },
                                    { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                                ]
                            }]
                        })
                    });
                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0].content) {
                        throw new Error("No se pudo reconocer la imagen.");
                    }
                    const rawText = data.candidates[0].content.parts[0].text;
                    const cleanJson = rawText.replace(/```json|```/g, '').trim();
                    const result = JSON.parse(cleanJson);
                    // Update Diet
                    const newDiet = [...data.diet];
                    // Logic: Replace the first unconsumed meal OR add a new one?
                    // Let's replace "Comida" (Lunch) if available, or just push a new "Smart Meal".
                    // User request: "Detecte alimentos". Let's insert it into the current day.
                    // To keep it simple for this UI, we'll try to fill the next unconsumed slot, OR replace 'lunch' if it's the usual time.
                    // Actually, let's just Overwrite the 'Comida' slot for demonstration or add a "Detected" slot?
                    // The prompt said "Lunch" in the mock. Let's make it smarter:
                    // Find first empty slot? Or just append? Appending is safer.
                    // But the UI expects fixed IDs? The UI map loops over `diet`. We can push.
                    const newMeal = {
                        id: `ai_${Date.now()}`,
                        name: result.name || 'Comida Detectada',
                        items: 'Detectado por Vision AI',
                        calories: result.calories,
                        macros: result.macros,
                        consumed: true // Auto-consume? Yes.
                    };
                    // Optional: Try to match it to a standard slot time-wise?
                    // For now, let's just append it to the list so user sees it clearly.
                    // Or ask user confirmation? The prompt implies "Detect and log".
                    // Let's Append.
                    // newDiet.push(newMeal);
                    // WAIT: The UI has 4 fixed slots usually. If we push, it might break layout if not scrollable?
                    // Layout is `space-y-4`, it handles lists fine.
                    // Let's PUT IT AT THE TOP or AFTER current meal?
                    // Let's replace the Logic of 'mockScan' which updated Lunch.
                    // Let's start by updating "Comida" if it exists and isn't done, else append.
                    const lunchIndex = newDiet.findIndex(m => m.id === 'lunch');
                    if (lunchIndex >= 0 && !newDiet[lunchIndex].consumed) {
                        newDiet[lunchIndex] = { ...newDiet[lunchIndex], ...newMeal, id: 'lunch' }; // Keep ID
                        alert(`✅ ${result.name} registrado en Comida.\n${result.calories} kcal`);
                    } else {
                        newDiet.push(newMeal);
                        alert(`✅ ${result.name} añadido a la dieta.\n${result.calories} kcal`);
                    }
                    setData(prev => ({ ...prev, diet: newDiet }));
                } catch (err) {
                    console.error("AI Error:", err);
                    alert("❌ Error analizando la imagen.\nVerifica tu API Key o intenta de nuevo.");
                } finally {
                    setAnalyzing(false);
                }
            };
            // Enhanced Exercise Update
            const updateExercise = (id, day, kg, done, maintained) => {
                const today = getTodayString();
                setData(prev => {
                    // 1. Update individual exercise state
                    const newExercises = {
                        ...prev.exercises,
                        [id]: {
                            kg: kg,
                            lastDone: done ? today : (prev.exercises[id]?.lastDone || ''),
                            maintained: maintained
                        }
                    };
                    // 2. Check if ALL exercises for this day are done TODAY
                    // This is for the "Routine History" (clean streak) logic
                    // We only log to history if the WHOLE routine is completed? 
                    // Or do we log partial? 
                    // The previous logic was: "onComplete -> saveWorkout".
                    // Let's keep it simple: We update history EVERY time an exercise changes? 
                    // No, that floods history.
                    // Ideally: We track "Routine Completion".
                    // For Simplicity in this V5: 
                    // We will NOT auto-add history on every click. 
                    // We only care about the *Streak*.
                    // The streak effectively comes from: "Did I do it last week?".
                    // But to keep the "2 weeks clean" logic, we DO need history.
                    // Let's auto-generate a history entry for Today if it doesn't exist?
                    // Or update the existing entry for Today.
                    const dayHistory = [...(prev.history[day] || [])];
                    const todayEntryIndex = dayHistory.findIndex(h => h.date === today);
                    // Calculate if the day is "maintained" (if ANY exercise is maintained)
                    // But 'maintained' is passed per exercise.
                    // If ANY exercise in the routine is 'maintained', the whole session acts as a reset/pause?
                    // Yes, user said: "toggle 'maintained' -> resets streak".
                    const isMaintained = maintained; // If this specific exercise is maintained.
                    // CAUTION: This might overwrite other exercises' status if we just take `maintained`.
                    // But for the alert logic, if *any* is maintained, streak breaks.
                    // Implementation: We'll construct a composite "maintained" status for the day.
                    // Does this routine have ANY maintained exercise?
                    // We need to look at `newExercises` for all IDs in this day.
                    const dayRoutine = WORKOUT_ROUTINE[day];
                    const allIds = dayRoutine ? dayRoutine.exercises.map(e => e.id) : [];
                    // Check if ALL are done?
                    const allDone = allIds.every(eid => newExercises[eid]?.lastDone === today);
                    const anyMaintained = allIds.some(eid => newExercises[eid]?.maintained === true);
                    if (allDone) {
                        if (todayEntryIndex >= 0) {
                            // Update existing
                            dayHistory[todayEntryIndex] = { date: today, maintained: anyMaintained };
                        } else {
                            // Add new
                            dayHistory.push({ date: today, maintained: anyMaintained });
                        }
                    } else {
                        // If not all done, remove today from history if it exists? 
                        // Or just leave it? Better to remove it so it doesn't count as a "session" yet.
                        if (todayEntryIndex >= 0) {
                            dayHistory.splice(todayEntryIndex, 1);
                        }
                    }
                    return {
                        ...prev,
                        exercises: newExercises,
                        history: { ...prev.history, [day]: dayHistory }
                    };
                });
            };
            return (
                <div className="app-container font-sans text-gray-100 p-4">
                    {tab === 'dashboard' && <Dashboard data={data} updateWater={updateWater} />}
                    {tab === 'diet' && <Diet diet={data.diet} updateDiet={updateDiet} toggleMeal={toggleMeal} mockScan={mockScan} />}
                    {tab === 'routine' && <Routine history={data.history} exercises={data.exercises} updateExercise={updateExercise} />}
                    <TabBar activeTab={tab} setTab={setTab} />
                    {/* Modals */}
                    {showSettings && <SettingsModal apiKey={apiKey} setApiKey={setApiKey} onClose={() => setShowSettings(false)} />}
                    {showCamera && <CameraModal isOpen={showCamera} onClose={() => setShowCamera(false)} onCapture={handleImageCaptured} />}
                    {analyzing && (
                        <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur">
                            <div className="w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mb-4"></div>
                            <h2 className="text-xl font-bold text-white animate-pulse">Analizando Alimentos...</h2>
                            <p className="text-gray-400 text-sm">Consultando a Gemini AI</p>
                        </div>
                    )}
                </div>
            );
        };
        // Mount
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }

    </script>
</body>

</html>